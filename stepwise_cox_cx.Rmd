---
title: "stepwise_cox_cx"
author: "Chuyuan XU"
date: "`r Sys.Date()`"
output: 
  github_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE) # keep it for now for easier checking

library(tidyverse)
library(skimr)
library(janitor)
library(ggplot2)
library(knitr)
library(kableExtra)
library(webshot2)
library(dplyr)
library(tidyr)
library(survival)
library(patchwork)
library(openxlsx)

library(glmnet) # for lasso
library(rms)    # for nomogram
```


# Data Preparation
## Data Wrangling (wenjie, zhaokun)
```{r wenjie_data_wrangling}
# Import data & data cleaning 
cirrhosis <- read.csv("data/cirrhosis.csv") |> clean_names()

# Status convert to event indicator (1 = death, 0 = censored)
cirrhosis <- cirrhosis |>
  mutate(
    event = case_when(
      status == "D" ~ 1,
      status %in% c("C", "CL") ~ 0,
      TRUE ~ NA_real_
    ),
    sex = factor(sex),
    drug = factor(drug),
    ascites = factor(ascites),
    hepatomegaly = factor(hepatomegaly),
    spiders = factor(spiders),
    edema = factor(edema, levels = c("N", "S", "Y"), ordered = TRUE),
    stage = factor(stage) # Yixin: "Stage: histologic stage of disease (1, 2, 3, or 4)"
  )

cirrhosis <- cirrhosis |>
  mutate(age_years = age / 365.25)

```


```{r extra prep}
# drop variables not needed in the following modeling
cirrhosis_df = cirrhosis |>
  mutate(
    # log_transformed bilirubin
    log_bilirubin = log(bilirubin),
    
    # edema group "S" "Y" combined
    edema_bin = case_when(
      edema == "N" ~ 0L,                  
      edema %in% c("S", "Y") ~ 1L,       
      TRUE ~ NA_integer_
    ),
  ) |>
  dplyr::select(-id, -status, -age, -tryglicerides, -cholesterol, -bilirubin, -edema) |>
  na.omit()
```

All rows with NA omitted for Stepwise and LASSO Cox model selection.
Log-transformed `Bilirubin` is included in the Cox model.
`Edama` derives a binary variable `Edema_bin` based on the presence or absence of Edema.

### Stepwise Cox
```{r stepwise_cx}
sw_full = coxph(
  Surv(n_days, event) ~ 
    drug + 
    sex + ascites + hepatomegaly + 
    spiders + edema_bin + albumin + 
    copper + alk_phos + sgot + 
    platelets + prothrombin + stage + 
    age_years + log_bilirubin,
  data = cirrhosis_df)

sw_null = coxph(
  Surv(n_days, event) ~ 
    1, 
  data = cirrhosis_df)

step_cox = MASS::stepAIC(sw_full, direction = "both", na.rm = TRUE)

summary(step_cox)

sw.cox_coef = step_cox |>
  broom::tidy() |>
  mutate(
    astrid = case_when(
      p.value < 0.001 ~ "***",
      p.value >= 0.001 & p.value <= 0.01 ~ "**",
      p.value >= 0.01 & p.value <= 0.05 ~ "*",
      TRUE ~ ""
    )
  )

sw.cox_coef |>
  knitr::kable(
    digits = 3,
    col.names = c("term", "estimate", "std.error", "statistic", "p.value", ""),
    caption = "Stepwise Cox Proportional Hazard Regression Model -- coefficients"
  )

sw.cox_test = step_cox |>
  broom::glance() |>
  select(
    n, nevent, statistic.wald, p.value.wald, logLik, AIC, BIC,
  ) 

sw.cox_test |>
  knitr::kable(
    digits = 3,
    caption = "Stepwise Cox Proportional Hazard Regression Model -- Global Tests Results"
  )

write.xlsx(
  list(
      coefficient = sw.cox_coef,
      tests = sw.cox_test
  ),
  file = "table_output/stepwise_cox.xlsx"
)
```

A Stepwise Cox Proportional Hazard regression was performed to identify the most parsimonious model that estimates subjects' hazard of Cirrhosis. The model selection was based on Akaikeâ€™s Information Criterion (AIC). The final model achieved the lowest AIC of `r round(sw.cox_test$AIC, 3)`, including the variables of Edema Presence, Albumin(mg/dl), Urine copper(ug/day), SGOT (U/ml), Prothrombin time (s), histologic stage of disease, age (years) and log-transformed serum Bilirubin (mg/dl) as predictors. Several variables showed significant associations (p < 0.05) with the hazard function, while disease stages (all p-values> 0.05) and SGOT (p-value > 0.01) are weaker contributors to the model. The overall model shows significant discriminatory ability over subjects' hazards with a concordance of 0.858. Global tests show the model has a good fit (Wald test, p <2e-16).

The final model from stepwise selection further supported the results from the above data Cox ph model that drug is an insignificant predictor. Urine copper and SGOT, in addition, were kept in the stepwise Cox model, but were removed in the final proposed model.



### Lasso Cox
```{r lasso}
set.seed(1234)
x = model.matrix(
    ~ drug + 
      sex + ascites + hepatomegaly + 
      spiders + edema_bin + albumin + 
      copper + alk_phos + sgot + 
      platelets + prothrombin + stage + 
      age_years + log_bilirubin - n_days - event, 
    data = cirrhosis_df)[, -1]

y = Surv(cirrhosis_df$n_days, cirrhosis_df$event)

lambda = 10^(seq(-2, 0, 0.05))

lasso_fit =
  glmnet(x, y, family = "cox", lambda = lambda)

lasso_cv =
  cv.glmnet(x, y, family = "cox", lambda = lambda, alpha = 1)

lambda_opt = lasso_cv[["lambda.min"]]
lambda_1se = lasso_cv[["lambda.1se"]]

lasso_plot1 = lasso_fit |> 
  broom::tidy() |> 
  select(term, lambda, estimate) |> 
  complete(term, lambda, fill = list(estimate = 0) ) |> 
  filter(term != "(Intercept)") |> 
  ggplot(aes(x = lambda, y = estimate, group = term, color = term)) + 
  geom_path() + 
  geom_vline(xintercept = lambda_opt, color = "blue", size = 1.2) +
  theme_minimal() + 
  theme(legend.position = "none")

lasso_plot1

plot(lasso_cv)

coef_lasso_opt = coef(lasso_cv, s = "lambda.min")
lasso_opt = data.frame(term = rownames(coef_lasso_opt), estimate_opt = as.numeric(coef_lasso_opt)) |>
  mutate(
    estimate_opt = case_when(
      estimate_opt == 0 ~ "-",
      TRUE ~ as.character(round(estimate_opt, 3))
    )
  )

coef_lasso_1se = coef(lasso_cv, s = "lambda.1se")
lasso_1se = data.frame(term = rownames(coef_lasso_1se), estimate_1se = as.numeric(coef_lasso_1se)) |>
  mutate(
    estimate_1se = case_when(
      estimate_1se == 0 ~ "-",
      TRUE ~ as.character(round(estimate_1se, 3))
    )
  )

lasso.cox = left_join(lasso_opt, lasso_1se, by = "term")

lasso.cox |>
  knitr::kable()

write.xlsx(
  lasso.cox,
  file = "table_output/lasso_cox.xlsx"
) 
```

Another Lasso Cox Proportional Hazard regression was performed to identify the most parsimonious model that estimates subjects' hazard of Cirrhosis. The model selection was based on the Penalty Parameter, lambda. Cross-validation further selects the lambda that generalizes the best, and determines variables to develop the final model.
The final model achieved the penalty parameter of `r round(lambda_opt, 3)`, including the variables of Ascites Presence, Edema Presence, Albumin(mg/dl), Urine copper(ug/day),  Prothrombin time (s), histologic stage 4 of disease, age (years) and log-transformed serum Bilirubin (mg/dl) as predictors. Another simpler model was provided with the log-transformed serum Bilirubin (mg/dl) as the only predictor, where allows the largest penalty parameter at which the MSE is within one standard error of the smallest MSE, which is `r round(lambda_1se, 3)`. The model with the smallest penalty parameter was considered due to its better performance in estimation.

The final model from Lasso selection further supported the results from the above data Cox Proportional Hazard model that drug is an insignificant predictor. Ascites Presence and Urine copper, in addition, was kept in the Lasso Cox model, but was removed in the final proposed model.

### Nomgram
```{r nomgram_cx}
# final model (Zhaokun)
dd <- datadist(cirrhosis_df)
options(datadist = "dd")

fit_nomo <- cph(
  Surv(n_days, event) ~
    drug +                # treatment: D-pen vs placebo
    age_years +           # age in years
    log_bilirubin +       # log-transformed bilirubin
    albumin +             # serum albumin
    prothrombin +         # prothrombin time
    edema_bin +           # edema: 0 = none, 1 = S/Y
    stage,                # histologic stage as stratification factor
  data = cirrhosis_df,
  x = TRUE, y = TRUE, surv = TRUE)

sf = Survival(fit_nomo)

# survival time for 1 year, 3 year and 5 year
surv_1y  <- function(lp) sf(365,  lp)
surv_3y  <- function(lp) sf(1095, lp)
surv_5y  <- function(lp) sf(1825, lp)

nomo <- nomogram(
  fit_nomo, 
  fun = list(
    "1-year Survival" = surv_1y,
    "3-year Survival" = surv_3y,
    "5-year Survival" = surv_5y
    ),
  funlabel = c("1-year Survival", "3-year Survival", "5-year Survival")
  )


plot(
  nomo,
  xfrac = 0.4,         # More room for labels
  lmgp = 0.5,          # left margin for variable names
  tcl = -0.5,          # Tick length
  cex.var = 0.8,       # variable label size
  cex.axis = 0.5,      # axis label size
  cex.points = 1.2,    # Points scale
  label.every = 2,     # Spread axis tick labels
  fun.spacing = 1.8,   # vertical spacing
  col.grid = "gray80",
)

title(
  main ="Nomogram for Cirrhosis Survival",
  sub = "1-, 3-, and 5-year survival predictions"
)
```

The figure shows the nomogram generated to estimate patients' 1-, 3-, and 5-year survival based on the final Cox PH survival prediction model. The nomogram produces similar results when treatment types are not strong predictors in the model. It translates the regression coefficients into a point-based scoring system, allowing clinicians to estimate 1-, 3-, and 5-year survival probabilities for patients with cirrhosis. Each predictor in the model (drug assignment, age, log-bilirubin, albumin, prothrombin time, presence of edema, and disease stage) has a scale that assigns a value to a specific hazard point, as indicated by the scale at the top of the figure. By summing a patient's points for each variable, therapists can obtain a total score and use it to estimate 1-, 3-, and 5-year survival probabilities, with higher total point values indicating lower predicted survival. Nomograms provide an intuitive and feasible method for applying the survival prediction model and enhance clinical decision-making by offering quick, individualized risk estimates.